<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pixel Perfection - Agente de Documentos</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        .mode-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            flex: 1;
            max-width: 400px;
            text-align: center;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }
        .mode-card.active {
            background: #f8f9ff;
            border: 3px solid #667eea;
        }
        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .workspace {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-height: 500px;
        }
        .document-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .doc-type {
            background: #f8f9ff;
            border: 2px solid #e1e5f2;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .doc-type:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        .doc-type.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .chat-container {
            display: none;
            flex-direction: column;
            height: 500px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e1e5f2;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9ff;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        .message.agent {
            background: white;
            border: 1px solid #e1e5f2;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e5f2;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        .direct-container {
            display: none;
        }
        .textarea-large {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e1e5f2;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        .partial {
            background: #fffaf0;
            border: 1px solid #fbb040;
            color: #744210;
        }
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: #667eea;
            height: 100%;
            transition: width 0.3s ease;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® 3D Pixel Perfection</h1>
        <p>Generador Inteligente de Documentos para Eventos</p>
    </div>

    <div class="mode-selector">
        <div class="mode-card active" onclick="selectMode('chat')">
            <div class="mode-icon">üí¨</div>
            <h3>Modo Conversacional</h3>
            <p>Te gu√≠o paso a paso para generar tu documento. Ideal para usuarios nuevos.</p>
        </div>
        <div class="mode-card" onclick="selectMode('direct')">
            <div class="mode-icon">‚ö°</div>
            <h3>Modo Directo</h3>
            <p>Pega tu transcripci√≥n completa y genera el documento inmediatamente.</p>
        </div>
    </div>

    <div class="workspace">
        <!-- Modo Conversacional -->
        <div id="chatMode" class="chat-container">
            <div class="document-types">
                <div class="doc-type" onclick="selectDocType('contrato_base')">
                    üìÑ <strong>Contrato Base</strong><br>
                    <small>Nuevo evento</small>
                </div>
                <div class="doc-type" onclick="selectDocType('anexo_a')">
                    üìã <strong>Anexo A</strong><br>
                    <small>Montaje y decoraci√≥n</small>
                </div>
                <div class="doc-type" onclick="selectDocType('anexo_b')">
                    üé® <strong>Anexo B</strong><br>
                    <small>Renders y temas</small>
                </div>
                <div class="doc-type" onclick="selectDocType('anexo_c')">
                    ‚úèÔ∏è <strong>Anexo C</strong><br>
                    <small>Control de cambios</small>
                </div>
                <div class="doc-type" onclick="selectDocType('anexo_d')">
                    ‚úÖ <strong>Anexo D</strong><br>
                    <small>Entrega final</small>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <textarea id="chatTextarea" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                <button class="btn" onclick="sendMessage()" id="sendBtn">Enviar</button>
            </div>
        </div>

        <!-- Modo Directo -->
        <div id="directMode" class="direct-container">
            <h3>Selecciona el tipo de documento:</h3>
            <div class="document-types">
                <div class="doc-type" onclick="selectDocTypeDirect('contrato_base')">
                    üìÑ <strong>Contrato Base</strong>
                </div>
                <div class="doc-type" onclick="selectDocTypeDirect('anexo_a')">
                    üìã <strong>Anexo A</strong>
                </div>
                <div class="doc-type" onclick="selectDocTypeDirect('anexo_b')">
                    üé® <strong>Anexo B</strong>
                </div>
                <div class="doc-type" onclick="selectDocTypeDirect('anexo_c')">
                    ‚úèÔ∏è <strong>Anexo C</strong>
                </div>
                <div class="doc-type" onclick="selectDocTypeDirect('anexo_d')">
                    ‚úÖ <strong>Anexo D</strong>
                </div>
            </div>
            
            <textarea id="directTextarea" class="textarea-large" placeholder="Pega aqu√≠ toda la informaci√≥n que tengas sobre el evento..."></textarea>
            <button class="btn" onclick="processDirectly()" id="processBtn">Procesar Documento</button>
            <div id="directResult"></div>
        </div>
    </div>

    <script>
        let currentMode = 'chat';
        let chatSessionId = null;
        let selectedDocType = null;
        let selectedDocTypeDirect = null;

        function selectMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
            document.querySelector(`[onclick="selectMode('${mode}')"]`).classList.add('active');
            
            if (mode === 'chat') {
                document.getElementById('chatMode').style.display = 'flex';
                document.getElementById('directMode').style.display = 'none';
                if (!chatSessionId) {
                    startChatSession();
                }
            } else {
                document.getElementById('chatMode').style.display = 'none';
                document.getElementById('directMode').style.display = 'block';
            }
        }

        function selectDocType(type) {
            selectedDocType = type;
            document.querySelectorAll('#chatMode .doc-type').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            
            if (chatSessionId) {
                sendMessageWithDocType(type);
            }
        }

        function selectDocTypeDirect(type) {
            selectedDocTypeDirect = type;
            document.querySelectorAll('#directMode .doc-type').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function startChatSession() {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: 'session_' + Date.now(),
                        action: 'start'
                    })
                });

                const data = await response.json();
                chatSessionId = data.sessionId;
                addMessage('agent', data.message);
            } catch (error) {
                addMessage('agent', 'Error iniciando conversaci√≥n: ' + error.message);
            }
        }

        async function sendMessage() {
            const textarea = document.getElementById('chatTextarea');
            const message = textarea.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            textarea.value = '';
            
            await sendMessageToAPI(message);
        }

        async function sendMessageWithDocType(docType) {
            await sendMessageToAPI(`Necesito un ${docType}`, docType);
        }

        async function sendMessageToAPI(message, docType = null) {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Enviando...';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: chatSessionId,
                        message: message,
                        documentType: docType,
                        action: 'continue'
                    })
                });

                const data = await response.json();
                
                if (data.complete) {
                    addMessage('agent', data.message);
                    if (data.documentUrl) {
                        addMessage('agent', `üîó Documento disponible en: ${data.documentUrl}`);
                    }
                } else {
                    addMessage('agent', data.message);
                    
                    if (data.progress) {
                        addProgressBar(data.progress.percentage);
                    }
                }
            } catch (error) {
                addMessage('agent', 'Error: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Enviar';
            }
        }

        async function processDirectly() {
            if (!selectedDocTypeDirect) {
                showDirectResult('Por favor selecciona un tipo de documento', 'error');
                return;
            }

            const textarea = document.getElementById('directTextarea');
            const transcripcion = textarea.value.trim();
            
            if (!transcripcion) {
                showDirectResult('Por favor ingresa la informaci√≥n del evento', 'error');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.textContent = 'Procesando...';

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcripcion: transcripcion
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const successText = `‚úÖ ${data.resumen}

üìÑ Tipo: ${data.tipo_documento}
üîó Documento: ${data.file_name || 'contrato-generado.pdf'}

üìã Datos extra√≠dos:
${JSON.stringify(data.datos_extraidos, null, 2)}`;

                    // Si hay PDF disponible, pasar datos para botones
                    const pdfData = data.pdf_direct ? {
                        base64: data.pdf_direct.base64,
                        fileName: data.file_name || 'contrato-generado.pdf',
                        size: data.pdf_direct.size
                    } : null;

                    showDirectResult(successText, 'success', pdfData);
                } else if (data.needsFollowUp) {
                    showDirectResult(`‚ÑπÔ∏è Informaci√≥n parcial extra√≠da

üìÑ Tipo detectado: ${data.tipo_documento}

${data.mensaje}`, 'partial');
                } else {
                    showDirectResult(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showDirectResult(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Procesar Documento';
            }
        }

        function addMessage(role, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addProgressBar(percentage) {
            const messagesContainer = document.getElementById('chatMessages');
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
                <small>Progreso: ${percentage}%</small>
            `;
            messagesContainer.appendChild(progressDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function downloadPDF(base64Data, fileName) {
            try {
                // Convertir base64 a bytes
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                
                // Crear blob PDF
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Crear enlace temporal
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName || 'contrato-generado.pdf';
                document.body.appendChild(a);
                a.click();
                
                // Limpiar
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error al descargar PDF: ' + error.message);
            }
        }

        function viewPDF(base64Data, fileName) {
            try {
                // Convertir base64 a bytes
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                
                // Crear blob PDF
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Abrir en nueva pesta√±a
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                
                // Limpiar despu√©s de un tiempo
                setTimeout(() => URL.revokeObjectURL(url), 60000);
            } catch (error) {
                alert('Error al visualizar PDF: ' + error.message);
            }
        }

        function showDirectResult(text, type, pdfData = null) {
            const resultDiv = document.getElementById('directResult');
            
            if (pdfData && pdfData.base64 && pdfData.fileName) {
                // Crear contenido con botones de descarga
                resultDiv.innerHTML = `
                    <div class="success-message">${text}</div>
                    <div class="pdf-actions" style="margin-top: 20px; text-align: center;">
                        <button onclick="downloadPDF('${pdfData.base64}', '${pdfData.fileName}')" 
                                style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 6px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            üì• Descargar PDF
                        </button>
                        <button onclick="viewPDF('${pdfData.base64}', '${pdfData.fileName}')" 
                                style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; margin: 0 10px; cursor: pointer; font-size: 16px;">
                            üëÅÔ∏è Ver PDF
                        </button>
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            üìä Tama√±o: ${Math.round(pdfData.size / 1024)} KB
                        </div>
                    </div>
                `;
            } else {
                resultDiv.textContent = text;
            }
            
            resultDiv.className = `result ${type}`;
        }

        // Inicializar chat al cargar
        window.addEventListener('load', () => {
            startChatSession();
        });

        // Enter para enviar mensaje
        document.getElementById('chatTextarea').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>